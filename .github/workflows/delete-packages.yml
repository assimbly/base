name: Delete Packages

on:
  push:
    branches:
      - 'workflows'

jobs:
    delete_base:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:

            - name: Checkout the code
              uses: actions/checkout@v3
              with:
                ref: "develop"
            
            - name: Set up JDK 11
              uses: actions/setup-java@v3
              with:
                java-version: '11'
                distribution: 'temurin'

            - name: Update POM Version
              env:
                VERSION: 4.0.0-SNAPSHOT
              run: |
                  echo "Updating to version: ${VERSION}"
                  mvn versions:set -DnewVersion=${VERSION}

            - name: Publish to Github Packages
              run: mvn --batch-mode deploy
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - uses: smartsquaregmbh/delete-old-packages@v0.6.0
              with:
                organization: assimbly
                type: maven
                keep: 0
                version-pattern: "^\\d+\\.\\d+\\.\\d+-SNAPSHOT\\d+$"
                names: |
                    base
                    common-base
                    camel-base
                    spring-base
                    activemq-base
                    test-base
                    database-drivers
                    camel-components
                    utils
                    extra